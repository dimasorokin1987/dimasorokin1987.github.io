<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name='viewport' content='width=device-width, initial-scale=1' />
  <title>Portfolio.</title>
  <link rel="stylesheet" type="text/css" href="https://dimasorokin1987.github.io/sliding-carousel/sliding-carousel.css" />
  <link rel="stylesheet" href="common.css" />
  <link rel="stylesheet" media="screen and (min-width: 900px)" href="wide.screensize.css" />
  <link rel="stylesheet" media="screen and (max-width: 900px) and (min-width: 600px)" href="medium.screensize.css" />
  <link rel="stylesheet" media="screen and (max-width: 600px)" href="small.screensize.css" />
  <link rel="stylesheet" href="light.theme.css" />
  <link rel="stylesheet" href="dark.theme.css" />
</head>

<body>
  <header>
    <label id="nav">
      <span class="caption"></span>
      <select onchange="location.href=this.value">
        <option value="#top"></option>
        <option value="#about"></option>
        <option value="#projects"></option>
        <option value="#skills"></option>
        <option value="#contacts"></option>
        <option value="#socials"></option>
      </select>
    </label>
    <div id="top"></div>
    <div class="switchers">
      <div class="locale switcher">
        <b>locale:</b>
        <label>
          <input type="radio" name="localeRadioButton" value="en">
          <span>en</span>
        </label>
        <label>
          <input type="radio" name="localeRadioButton" value="ru">
          <span>ru</span>
        </label>
        <label>
          <input type="radio" name="localeRadioButton" value="ua">
          <span>ua</span>
        </label>
      </div>
      <div class="theme switcher">
        <b>theme:</b>
        <label>
          <input type="radio" name="themeRadioButton" value="light_theme">
          <span>light</span>
        </label>
        <label>
          <input type="radio" name="themeRadioButton" value="dark_theme">
          <span>dark</span>
        </label>
      </div>
    </div>
    <div class="clear float"></div>
  </header>
  <main>
    <h1 class="header"></h1>
    <section id="about">
      <h2 class="header"></h2>
      <p class="content"></p>
    </section>
    <section class="sliding-carousel" id="projects-carousel">
      <div class="main-container">
        <button class="prevButton">&lt;</button>
        <div class="slides">
          <figure>
            <img src="weather_pwa1.screenshot.png">
            <figcaption class="weather-pwa-project-text"></figcaption>
          </figure>
          <figure>
            <img src="weather_pwa2.screenshot.png">
            <figcaption class="weather-pwa-project-text"></figcaption>
          </figure>
          <figure>
            <img src="react-dashboard1.screenshot.png">
            <figcaption class="react-dashboard-project-text"></figcaption>
          </figure>
          <figure>
            <img src="urlshortener1.screenshot.png">
            <figcaption class="url-shortener-project-text"></figcaption>
          </figure>
          <figure>
            <img src="react-chat1.screenshot.png">
            <figcaption class="react-chat-project-text"></figcaption>
          </figure>
          <figure>
            <img src="react-chat2.screenshot.png">
            <figcaption class="react-chat-project-text"></figcaption>
          </figure>
          <figure>
            <img src="serverless-guestbook1.screenshot.png">
            <figcaption class="serverless-guestbook-text"></figcaption>
          </figure>
          <figure>
            <img src="serverless-guestbook2.screenshot.png">
            <figcaption class="serverless-guestbook-text"></figcaption>
          </figure>
        </div>
        <button class="nextButton">&gt;</button>
      </div>
      <div class="radios"><input type="radio" name="position"><input type="radio" name="position"><input type="radio" name="position"><input type="radio" name="position"><input type="radio" name="position"></div>
    </section>
    <section id="projects">
      <h2 class="header"></h2>
      <ul>
        <li>
          <a href="https://pedantic-davinci-d8e40a.netlify.app/" target="_blank" class="weather-pwa-project-text"></a>
        </li>
        <li>
          <a href="/react-dashboard/" target="_blank" class="react-dashboard-project-text"></a>
        </li>
        <li>
          <a href="https://dimasorokin1987.github.io/urlshortener/" target="_blank" class="url-shortener-project-text"></a>
        </li>
        <li>
          <a href="https://dazzling-euclid-bf091e.netlify.app/" target="_blank" class="react-chat-project-text"></a>
        </li>
        <li>
          <a href="https://dimasorokin1987.github.io/serverless-guestbook/" target="_blank" class="serverless-guestbook-text"></a>
        </li>
      </ul>
    </section>
    <div class="clear float"></div>
    <section id="skills">
      <h2 class="header"></h2>
      <ul>
        <li><img class="skill icon" src="vsc.icon.svg" /></li>
        <li><img class="skill icon" src="html5.icon.svg" /></li>
        <li><img class="skill icon" src="css3.icon.svg" /></li>
        <li><img class="skill icon" src="js.icon.svg" /></li>
        <li><img class="skill icon" src="react.icon.svg" /></li>
        <li><img class="skill icon" src="mongodb.icon.svg" /></li>
        <li><img class="skill icon" src="ts.icon.svg" /></li>
        <li><img class="skill icon" src="webpack.icon.svg" /></li>
        <li><img class="skill icon" src="nodejs.icon.svg" /></li>
        <li><img class="skill icon" src="git.icon.svg" /></li>
        <li><img class="skill icon" src="ssh.icon.svg" /></li>
        <li><img class="skill icon" src="docker.icon.svg" /></li>
      </ul>
    </section>
    <section id="contacts">
      <h2 class="header"></h2>
      <ul>
        <li>
          <a href="https://somesoft-workspace.slack.com/team/U0102GXF6CX" target="_blank">
            <img class="icon" src="slack.icon.svg" />
            <span class="text">somesoft-workspace.slack.com</span>
          </a>
        </li>
        <li>
          <a href="https://join.skype.com/invite/nMoHIo242o2M" target="_blank">
            <img class="icon" src="skype.icon.svg" />
            <span class="text">dimasorokin1987</span>
          </a>
        </li>
      </ul>
    </section>
  </main>
  <hr>
  <footer>
    <section id="socials">
      <ul>
        <li>
          <a href="https://www.facebook.com/profile.php?id=100008725081649" target="_blank">
            <span class="facebook letter icon">f</span>
          </a>
        </li>
        <li>
          <a href="https://www.linkedin.com/in/dima-sorokin-016bbbaa/" target="_blank">
            <span class="linkedin letter icon">in</span>
          </a>
        </li>
      </ul>
    </section>
    <section id="online-chat-container">
      <div id="messages"></div>
      <a id="toggle-chat" href="#"><img class="online-chat icon" src="online-chat.icon.svg" /></a>
      <div id="chat">
        <textarea id="message" placeholder="Enter your message..."></textarea>
        <button>OK</button>
      </div>
    </section>
  </footer>

  <script type="module">
    import { applyLoopedSlidingCarousel } from 'https://dimasorokin1987.github.io/sliding-carousel/looped-sliding-carousel.mjs';
    applyLoopedSlidingCarousel('#projects-carousel.sliding-carousel');

    //const socketChatUrl = 'wss://echo-websocket-server.herokuapp.com/ws';
    const socketChatUrl = 'wss://websocket-simple-bot.herokuapp.com/ws';
    const memoize = f => {
      const results = {};
      return async(arg)=>{
        if(!results[arg]){
          results[arg] = await f(arg);
        }
        return results[arg];
      };
    };

    const loadLocaleTexts = async(locale)=>{
      const response = await fetch('texts.'+locale+'.json');
      const texts = await response.json();
      return texts;
    };
    const getLocaleTexts = memoize(loadLocaleTexts);

    const $body = document.querySelector('body');
    const $themeRadioButtons = document.querySelectorAll('input[name=themeRadioButton]');
    const $localeRadioButtons = document.querySelectorAll('input[name=localeRadioButton]');
    const $toggleChatButton = document.querySelector('#toggle-chat');
    const $chat = document.querySelector('#chat');
    const $messages = document.querySelector('#messages');
    const $message = document.querySelector('#message');
    const $sendMessageButton = document.querySelector('#chat button');
    

    const applyTheme = theme => {
      let currentTheme = [...$body.classList].find(cl=>cl.endsWith('_theme'));
      if(currentTheme){
        $body.classList.replace(currentTheme, theme);
      }else{
        $body.classList.add(theme);
      }
    };

    const updateTexts = async(lang) => {
      const texts = await getLocaleTexts(lang);
      Object.entries(texts).forEach(([selector,text]) => {
        document.querySelectorAll(selector).forEach(el=>{
          el.innerHTML = text;
        });
      });
    };

    $themeRadioButtons.forEach($themeRadioButton=>{
      $themeRadioButton.addEventListener('change', e => {
        let theme = e.target.value;
        console.log(theme);
        localStorage.storedTheme = theme;
        applyTheme(theme);
      }, false);
    });

    $localeRadioButtons.forEach($btn=>{
      $btn.addEventListener('change', async(e) => {
        let locale = e.target.value;
        console.log(locale);
        localStorage.storedLocale = locale;
        await updateTexts(locale);
      }, false);
    });


    $toggleChatButton.onclick = e=>{
      e.preventDefault();
      $chat.style.display = $chat.style.display==='none'? 'block': 'none';
      $messages.style.display = $messages.style.display==='none'? 'block': 'none';
    };

    const socket = new WebSocket(socketChatUrl)
    socket.onerror = err=>{
      console.log(`Socket error: ${err.message}`);
    };
    socket.onopen = ()=>{
      console.log(`Connected to ${socketChatUrl}`);
      $sendMessageButton.onclick = async()=>{
        let text = $message.value;
        let str = JSON.stringify({text});
        socket.send(str);
        let $msg = document.createElement('div');
        $msg.classList.add('own');
        $msg.innerText = text;
        $messages.appendChild($msg);
        let $br = document.createElement('br');
        $messages.appendChild($br);
        $messages.scrollTo(0, $messages.scrollHeight);
        $message.value = '';
      };
    };
    socket.onclose = e=>{
      if (e.wasClean) {
        console.log('Connection close clean');
      } else {
        console.log('Connection aborted'); // например, "убит" процесс сервера
      }
      console.log(`Code: ${e.code}, reason: ${e.reason}`);
    };
    socket.onmessage = e=>{
      let obj = JSON.parse(e.data);
      let txt = obj.text;
      //alert(`Data received: ${e.data}`);
      let $msg = document.createElement('div');
      $msg.classList.add('reply');
      $msg.innerText = txt;
      $messages.appendChild($msg);
      let $br = document.createElement('br');
      $messages.appendChild($br);
      $messages.scrollTo(0, $messages.scrollHeight);
    };
/*
    $sendMessageButton.onclick = async()=>{
      let msg = $message.value;
      let url = `https://send-slack-message.herokuapp.com/?txt=${msg}`;
      let r = await fetch(url);
      let txt = await r.text();
      console.log(txt);
      $message.value = '';
    };
*/
    const changeTheme = theme => {
      $themeRadioButtons.forEach(btn => {
        if(btn.value === theme) btn.click();
      });
    };
    const changeLocale = locale => {
      $localeRadioButtons.forEach(btn => {
        if(btn.value === locale) btn.click();
      });
    };

    let storedTheme = localStorage.storedTheme || 'light_theme';
    let storedLocale = localStorage.storedLocale || 'en';
   
    changeTheme(storedTheme);
    changeLocale(storedLocale);
  </script>
</body>
</html>
